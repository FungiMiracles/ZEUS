{% extends "base_layout.html" %}
{% block title %}Kalkulator demograficzny{% endblock %}

{% block content %}

<style>
/* ============================================================
   ZEUS — KALKULATOR DEMOGRAFICZNY
============================================================ */

.demo-calc {
    max-width: 1100px;
    margin: 0 auto;
    font-family: "Segoe UI", Tahoma, sans-serif;
    color: #2c3e50;
}

.demo-header {
    text-align: center;
    margin: 25px 0 35px 0;
}

.demo-header h1 {
    font-size: 1.9em;
    font-weight: 700;
}

.selector-box,
.region-box,
.summary-box {
    background: #ffffff;
    border-radius: 12px;
    padding: 20px 25px;
    margin-bottom: 25px;
    border: 1px solid #d3d7dc;
    box-shadow: 0 3px 8px rgba(0,0,0,0.08);
}

.selector-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    align-items: end;
}

.selector-grid label {
    font-weight: 700;
    font-size: 0.9em;
}

.selector-grid select {
    width: 100%;
    padding: 8px 10px;
    border-radius: 6px;
    border: 1px solid #b4b9be;
}

.btn-main {
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 700;
    border: none;
    cursor: pointer;
    background-color: #5d7dce;
    color: white;
}

.btn-main:hover {
    background-color: #315eb8;
}

.region-grid {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr;
    gap: 12px;
    align-items: center;
}

.region-grid input {
    width: 100%;
    padding: 6px 8px;
    border-radius: 6px;
    border: 1px solid #b4b9be;
}

.region-header {
    font-weight: 700;
    background: #eef1f7;
    padding: 10px;
    border-radius: 6px;
}

.summary-box {
    text-align: center;
}

.summary-box h2 {
    font-size: 1.4em;
    margin-bottom: 15px;
}
</style>

<div class="demo-calc">

    <div class="demo-header">
        <h1>Kalkulator demograficzny</h1>
    </div>

    <!-- ==================== WYBÓR ==================== -->
    {% if not panstwo %}
    <form method="GET" action="{{ url_for('demografia_kalkulator_start') }}" class="selector-box">
          <div class="selector-grid">
      
              <div>
                  <label>Kontynent</label>
                  <select name="kontynent">
                      <option value="">— wybierz —</option>
                      {% for k in kontynenty %}
                          <option value="{{ k }}"
                              {% if k == selected_kontynent %}selected{% endif %}>
                              {{ k }}
                          </option>
                      {% endfor %}
                  </select>
              </div>
      
              <div>
                  <label>Państwo</label>
                  <select name="panstwo_id">
                      <option value="">— wybierz —</option>
                      {% for p in panstwa %}
                          <option value="{{ p.PANSTWO_ID }}"
                              {% if panstwo and p.PANSTWO_ID == panstwo.PANSTWO_ID %}selected{% endif %}>
                              {{ p.panstwo_nazwa }}
                          </option>
                      {% endfor %}
                  </select>
              </div>
      
              <div>
                  <button class="btn-main" type="submit">
                      Przejdź do przeliczenia
                  </button>
              </div>
      
          </div>
      </form>
    {% endif %}

    <!-- ==================== REGIONY ==================== -->
    {% if panstwo %}
    <div class="region-box">
        <h2>{{ panstwo.panstwo_nazwa }} — regiony</h2>

        <div class="region-grid region-header">
            <div>Region</div>
            <div>Ludność miejska</div>
            <div>Ludność pozamiejska</div>
            <div>Suma regionu</div>
        </div>

        {% for r in regiony %}
        <div class="region-grid" data-region-id="{{ r.region_id }}" style="margin-top:8px;">
            <div><strong>{{ r.region_nazwa }}</strong></div>
            <div>{{ r.ludnosc_miejska | spacenum }}</div>
            <div>
                <input
                   type="number"
                   min="0"
                   value="0"
                   class="rural-input"
                   data-urban="{{ r.ludnosc_miejska }}"
               >
            </div>
            <div class="region-sum">—</div>
        </div>
        {% endfor %}
    </div>

    <div class="summary-box">
        <h2>Suma populacji państwa</h2>
        <p id="country-sum" style="font-size:1.4em; font-weight:700;">—</p>

       <p style="color:#27ae60; font-weight:600; margin-top:8px;">
          ✓ Populacja liczona na bieżąco
      </p>
       
        <br><br>
        <button
             class="btn-main"
             style="background:#27ae60;"
             onclick="commitDemography()"
         >
             Zrzuć do bazy danych
         </button>
    </div>
    {% endif %}

</div>

<script>
function formatNumber(n) {
    return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
}

function recalcDemography() {
    let totalCountry = 0;

    document.querySelectorAll(".rural-input").forEach(input => {
        const urban = parseInt(input.dataset.urban || 0);
        const rural = parseInt(input.value || 0);

        const regionTotal = urban + rural;
        totalCountry += regionTotal;

        const sumBox = input.closest(".region-grid").querySelector(".region-sum");
        sumBox.textContent = formatNumber(regionTotal);
    });

    document.getElementById("country-sum").textContent =
        totalCountry > 0 ? formatNumber(totalCountry) : "—";
}

// Live update
document.querySelectorAll(".rural-input").forEach(input => {
    input.addEventListener("input", recalcDemography);
});

// First run (safety)
recalcDemography();
</script>
<script>
function commitDemography() {
    const regions = [];

    document.querySelectorAll(".rural-input").forEach(input => {
        const regionGrid = input.closest(".region-grid");

        const regionId = regionGrid.dataset.regionId;
        const urban = parseInt(input.dataset.urban || 0);
        const rural = parseInt(input.value || 0);

        regions.push({
          region_id: parseInt(regionId),
          region_populacja: urban + rural,
          region_ludnosc_pozamiejska: rural
      });
    });

    fetch(window.location.pathname + "/zapisz", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ regions })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert("Dane demograficzne zapisane w bazie danych.");
            location.reload();
        } else {
            alert("Błąd zapisu: " + data.error);
        }
    })
    .catch(err => {
        alert("Błąd komunikacji z serwerem.");
        console.error(err);
    });
}
</script>

{% endblock %}
