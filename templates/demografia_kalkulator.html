{% extends "base_layout.html" %}
{% block title %}Kalkulator demograficzny{% endblock %}

{% block content %}

<style>
/* ============================================================
   ZEUS — KALKULATOR DEMOGRAFICZNY
============================================================ */

.demo-calc {
    max-width: 1100px;
    margin: 0 auto;
    font-family: "Segoe UI", Tahoma, sans-serif;
    color: #2c3e50;
}

.demo-header {
    text-align: center;
    margin: 25px 0 35px 0;
}

.demo-header h1 {
    font-size: 1.9em;
    font-weight: 700;
}

.selector-box,
.region-box,
.summary-box {
    background: #ffffff;
    border-radius: 12px;
    padding: 20px 25px;
    margin-bottom: 25px;
    border: 1px solid #d3d7dc;
    box-shadow: 0 3px 8px rgba(0,0,0,0.08);
}

.selector-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    align-items: end;
}

.selector-grid label {
    font-weight: 700;
    font-size: 0.9em;
}

.selector-grid select {
    width: 100%;
    padding: 8px 10px;
    border-radius: 6px;
    border: 1px solid #b4b9be;
}

.btn-main {
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 700;
    border: none;
    cursor: pointer;
    background-color: #5d7dce;
    color: white;
}

.btn-main:hover {
    background-color: #315eb8;
}

.region-grid {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
    gap: 12px;
    align-items: center;
}

.region-grid input {
    width: 100%;
    padding: 6px 8px;
    border-radius: 6px;
    border: 1px solid #b4b9be;
}

.region-header {
    font-weight: 700;
    background: #eef1f7;
    padding: 10px;
    border-radius: 6px;
}

.summary-box {
    text-align: center;
}

.summary-box h2 {
    font-size: 1.4em;
    margin-bottom: 15px;
}

/* ============================================================
   MOBILE — KALKULATOR DEMOGRAFICZNY
   TYLKO UKŁAD, DESKTOP NIETKNIĘTY
============================================================ */
@media (max-width: 768px) {

    /* ===== KONTAINER ===== */
    .demo-calc {
        padding: 0 10px;
    }

    /* ===== HEADER ===== */
    .demo-header h1 {
        font-size: 1.4em;
    }

    /* ===== SELECTORY ===== */
    .selector-grid {
        grid-template-columns: 1fr;
        gap: 14px;
    }

    .btn-main {
        width: 100%;
    }

    /* ===== REGIONY — KARTY ===== */
    .region-grid {
        grid-template-columns: 1fr;
        gap: 8px;
        padding: 12px;
        border: 1px solid #e0e4ea;
        border-radius: 10px;
        margin-top: 12px;
        background: #fafbfc;
    }

    /* Ukryj nagłówek tabeli */
    .region-grid.region-header {
        display: none;
    }

    /* Etykiety pseudo */
    .region-grid > div:nth-child(1)::before {
        content: "Region";
        display: block;
        font-weight: 700;
        color: #7f8c8d;
        font-size: 0.75em;
        margin-bottom: 2px;
    }

    .region-grid > div:nth-child(2)::before {
        content: "Ludność miejska";
        display: block;
        font-weight: 700;
        color: #7f8c8d;
        font-size: 0.75em;
        margin-bottom: 2px;
    }

    .region-grid > div:nth-child(3)::before {
        content: "Ludność pozamiejska";
        display: block;
        font-weight: 700;
        color: #7f8c8d;
        font-size: 0.75em;
        margin-bottom: 2px;
    }

    .region-grid > div:nth-child(5)::before {
    content: "Urbanizacja";
    display: block;
    font-weight: 700;
    color: #7f8c8d;
    font-size: 0.75em;
    margin-bottom: 2px;
   }

    /* ===== INPUT ===== */
    .region-grid input {
        padding: 8px;
        font-size: 1em;
    }

    /* ===== PODSUMOWANIE ===== */
    .summary-box {
        padding: 18px 15px;
    }

    .summary-box h2 {
        font-size: 1.2em;
    }

    #country-sum {
        font-size: 1.6em;
    }
}
</style>

<div class="demo-calc">

    <div class="demo-header">
        <h1>Kalkulator demograficzny</h1>
    </div>

    <!-- ==================== WYBÓR ==================== -->
    {% if not panstwo %}
    <form method="GET" action="{{ url_for('demografia_kalkulator') }}" class="selector-box">
          <div class="selector-grid">
      
              <div>
                  <label>Kontynent</label>
                  <select name="kontynent" onchange="this.form.submit()">
                      <option value="">— wybierz —</option>
                      {% for k in kontynenty %}
                          <option value="{{ k }}"
                              {% if k == selected_kontynent %}selected{% endif %}>
                              {{ k }}
                          </option>
                      {% endfor %}
                  </select>
              </div>
      
              <div>
                  <label>Państwo</label>
                  <select name="panstwo_id">
                      <option value="">— wybierz —</option>
                      {% for p in panstwa %}
                          <option value="{{ p.PANSTWO_ID }}"
                              {% if panstwo and p.PANSTWO_ID == panstwo.PANSTWO_ID %}selected{% endif %}>
                              {{ p.panstwo_nazwa }}
                          </option>
                      {% endfor %}
                  </select>
              </div>
      
              <div>
                  <button class="btn-main" type="submit">
                      Przejdź do przeliczenia
                  </button>
              </div>
      
          </div>
      </form>
    {% endif %}

    <!-- ==================== REGIONY ==================== -->
    {% if panstwo %}
        <form method="GET" action="{{ url_for('demografia_kalkulator') }}" class="selector-box">
          <div class="selector-grid">
      
              <div>
                  <label>Kontynent</label>
                  <select name="kontynent" onchange="this.form.submit()">
                      <option value="">— wybierz —</option>
                      {% for k in kontynenty %}
                          <option value="{{ k }}"
                              {% if k == selected_kontynent %}selected{% endif %}>
                              {{ k }}
                          </option>
                      {% endfor %}
                  </select>
              </div>
      
              <div>
                  <label>Państwo</label>
                  <select name="panstwo_id">
                      <option value="">— wybierz —</option>
                      {% for p in panstwa %}
                          <option value="{{ p.PANSTWO_ID }}"
                              {% if panstwo and p.PANSTWO_ID == panstwo.PANSTWO_ID %}selected{% endif %}>
                              {{ p.panstwo_nazwa }}
                          </option>
                      {% endfor %}
                  </select>
              </div>
      
              <div>
                  <button class="btn-main" type="submit">
                      Przejdź do przeliczenia
                  </button>
              </div>
      
          </div>
      </form>
    <div class="region-box">
        <h2>{{ panstwo.panstwo_nazwa }} — regiony</h2>

        <div class="region-grid region-header">
            <div>Region</div>
            <div>Ludność miejska</div>
            <div>Ludność pozamiejska</div>
            <div>Suma regionu</div>
            <div>Urbanizacja</div>
        </div>

        {% for r in regiony %}
            <div class="region-grid" data-region-id="{{ r.region_id }}" style="margin-top:8px;">
                <div><strong>{{ r.region_nazwa }}</strong></div>
                <div>{{ r.ludnosc_miejska | spacenum }}</div>
                <div>
                    <input
                        type="number"
                        min="0"
                        value="{{ r.region_ludnosc_pozamiejska or 0 }}"
                        class="rural-input"
                        data-urban="{{ r.ludnosc_miejska }}"
                    >
                </div>
                <div class="region-sum">—</div>
                <div class="region-urban-pct">—</div>
            </div>
        {% endfor %}
    </div>

    <div class="summary-box">
        <h2>Suma populacji państwa</h2>
        <p id="country-sum" style="font-size:1.4em; font-weight:700;">—</p>

        <p id="country-urban-pct"
         style="font-size:1.1em; font-weight:700; margin-top:6px;">
          —
        </p>

       
       <p style="color:#27ae60; font-weight:600; margin-top:8px;">
          ✓ Populacja liczona na bieżąco
      </p>
       
        <br><br>
       {% if session.rola == "wszechmocny" %}
        <button
             class="btn-main"
             style="background:#27ae60;"
             onclick="commitDemography()"
         >
             Zrzuć do bazy danych
         </button>
       {% else %}
        <button
             class="btn-main"
             style="background:#27ae60;"
             onclick="zeusToast('Twoja obecna rola nie pozwala na tę akcję')"
         >
             Zrzuć do bazy danych
         </button>
       {% endif %}
          <br><br> 
       <a class="btn-main" style="background:#a00d0d;" href="{{ url_for('demografia') }}" > Wróć </a>
    </div>
    {% endif %}

</div>

{% if panstwo %}
<script>
    const PANSTWO_ID = {{ panstwo.PANSTWO_ID }};
</script>
{% endif %}

<script>
function formatNumber(n) {
    return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
}

function getUrbanizationColor(pct) {
    if (pct < 50) {
        return "#e67e22"; // pomarańczowy
    } else if (pct < 80) {
        return "#27ae60"; // zielony
    } else if (pct < 90) {
        return "#e67e22"; // pomarańczowy
    } else {
        return "#c0392b"; // czerwony
    }
}

function recalcDemography() {
    let totalCountry = 0;
    let totalUrban = 0;

    document.querySelectorAll(".rural-input").forEach(input => {
        const regionGrid = input.closest(".region-grid");

        const urban = parseInt(input.dataset.urban || 0);
        const rural = parseInt(input.value || 0);

        const regionTotal = urban + rural;

        totalCountry += regionTotal;
        totalUrban += urban;

        // ===== Suma regionu =====
        const sumBox = regionGrid.querySelector(".region-sum");
        sumBox.textContent = regionTotal > 0
            ? formatNumber(regionTotal)
            : "—";

        // ===== % urbanizacji regionu =====
        const pctBox = regionGrid.querySelector(".region-urban-pct");

        if (regionTotal > 0) {
            const pct = (urban / regionTotal) * 100;
            pctBox.textContent = pct.toFixed(1) + " %";
            pctBox.style.fontWeight = "700";
            pctBox.style.color = getUrbanizationColor(pct);
        } else {
            pctBox.textContent = "—";
            pctBox.style.color = "#7f8c8d";
        }
    });

    // ===== Suma populacji państwa =====
    const countrySumBox = document.getElementById("country-sum");
    countrySumBox.textContent =
        totalCountry > 0 ? formatNumber(totalCountry) : "—";

    // ===== Urbanizacja państwa (WAGOWA) =====
    const countryPctBox = document.getElementById("country-urban-pct");

    if (totalCountry > 0) {
        const pctCountry = (totalUrban / totalCountry) * 100;
        countryPctBox.textContent =
            "Urbanizacja państwa: " + pctCountry.toFixed(1) + " %";
        countryPctBox.style.color = getUrbanizationColor(pctCountry);
    } else {
        countryPctBox.textContent = "Urbanizacja państwa: —";
        countryPctBox.style.color = "#7f8c8d";
    }
}

// ===== Live update =====
document.querySelectorAll(".rural-input").forEach(input => {
    input.addEventListener("input", recalcDemography);
});

// ===== Pierwsze przeliczenie =====
recalcDemography();
</script>

{% endblock %}
